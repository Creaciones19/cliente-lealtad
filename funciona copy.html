<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Registrar Visita</title>

<!-- QR Scanner -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
* { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
body { margin:0; height:100vh; background-image:url("https://images.unsplash.com/photo-1521017432531-fbd92d768814"); background-size:cover; background-position:center; display:flex; justify-content:center; align-items:center; }
.overlay { position:fixed; inset:0; background:rgba(0,0,0,0.55); }
.card { position:relative; z-index:2; background:#00754A; width:90%; max-width:380px; padding:35px 30px; border-radius:18px; text-align:center; color:white; }
.negocio { font-size:22px; font-weight:600; margin-bottom:10px; }
h1 { font-size:24px; margin-bottom:10px; }
p { font-size:15px; }
button { width:100%; margin-top:25px; padding:16px; font-size:18px; border:none; border-radius:12px; background:white; color:#00754A; cursor:pointer; }
#status { margin-top:20px; min-height:22px; font-size:16px; }

/* Modales y scanner */
.scan-modal { position:fixed; inset:0; background:rgba(0,0,0,0.85); display:none; justify-content:center; align-items:center; z-index:9999; }
.scanner-container { position:relative; width:280px; height:280px; }
#reader { width:100%; height:100%; border-radius:16px; overflow:hidden; }
.scan-frame { position:absolute; inset:0; border:3px solid rgba(255,255,255,0.9); border-radius:16px; pointer-events:none; }
.scan-line { position:absolute; left:0; right:0; height:2px; background:#00ff9d; animation:scan 2s linear infinite; }
@keyframes scan { from{top:10%;} to{top:90%;} }
.scan-text { margin-top:15px; color:white; font-size:14px; text-align:center; }
.btn-cancel { margin-top:18px; background:#ffffff; color:#333; border-radius:10px; padding:12px; border:none; width:100%; cursor:pointer; }
input { margin:5px 0; padding:10px; width:90%; border-radius:8px; border:none; }

/* Toast */
#toast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #fff;
  color: #00754A;
  padding: 12px 20px;
  border-radius: 10px;
  font-weight:600;
  display:none;
  z-index:10000;
  box-shadow:0 4px 12px rgba(0,0,0,0.3);
}
</style>
</head>
<body>

<div class="overlay"></div>

<div class="card">
  <div class="negocio">Restaurante Buon Appetito</div>
  <h1>Registrar Visita</h1>
  <p>Escanear el QR del cliente</p>
  <button id="scanBtn">ðŸ“· Escanear QR</button>
  <div id="status"></div>
</div>

<!-- MODAL ESCÃNER -->
<div id="scanModal" class="scan-modal" onclick="cerrarEscaner()">
  <div onclick="event.stopPropagation()">
    <div class="scanner-container">
      <div id="reader"></div>
      <div class="scan-frame"></div>
      <div class="scan-line"></div>
    </div>
    <div class="scan-text">Coloca el QR dentro del marco</div>
    <button class="btn-cancel" onclick="cerrarEscaner()">Cancelar</button>
  </div>
</div>

<!-- MODAL NUEVO CLIENTE -->
<div id="nuevoClienteModal" class="scan-modal" onclick="cerrarNuevoClienteModal()">
  <div style="background:#00754A; padding:30px; border-radius:18px; text-align:center; color:white; max-width:350px; margin:auto;" onclick="event.stopPropagation()">
    <h2>Bienvenido!</h2>
    <p>Ingresa tu informaciÃ³n para registrar tu visita</p>
    <input type="text" id="nombreInput" placeholder="Nombre completo">
    <input type="date" id="cumpleInput">
    <button onclick="guardarCliente()">Guardar</button>
    <button onclick="cerrarNuevoClienteModal()">Cancelar</button>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

<script>
// ConfiguraciÃ³n Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBbFAbpOJvhBu_QR16Ep7WfRqcLaHW1F1s",
  authDomain: "cliente-lealtad.firebaseapp.com",
  databaseURL: "https://cliente-lealtad-default-rtdb.firebaseio.com",
  projectId: "cliente-lealtad",
  storageBucket: "cliente-lealtad.firebasestorage.app",
  messagingSenderId: "19568539350",
  appId: "1:19568539350:web:0f545162141039a376bb77",
  measurementId: "G-6GP76P39G8"
};
firebase.initializeApp(firebaseConfig);

// DOM
const scanBtn = document.getElementById("scanBtn");
const scanModal = document.getElementById("scanModal");
const statusDiv = document.getElementById("status");
const nuevoClienteModal = document.getElementById("nuevoClienteModal");
const toast = document.getElementById("toast");

let qrScanner = null;
let nuevoClienteData = {};

// ===== Toast =====
function showToast(msg) {
  toast.innerText = msg;
  toast.style.display = "block";
  setTimeout(()=> toast.style.display = "none", 3000);
}

// ===== ESCANEAR QR =====
scanBtn.addEventListener("click", () => {
  if (qrScanner) return;
  scanModal.style.display = "flex";
  qrScanner = new Html5Qrcode("reader");
  qrScanner.start(
    { facingMode: "environment" },
    { fps:10, qrbox:220 },
    (qrText) => {
      cerrarEscaner();
      if(!qrText || qrText.trim()==="") {
        showToast("QR invÃ¡lido. Intenta de nuevo.");
        return;
      }
      procesarCliente(qrText.trim());
    }
  ).catch(err => { console.log("Error cÃ¡mara:", err); scanModal.style.display="none"; qrScanner=null; showToast("No se pudo iniciar la cÃ¡mara."); });
});

// ===== CERRAR ESCANER =====
function cerrarEscaner() {
  if (qrScanner) qrScanner.stop().then(()=>qrScanner.clear()).catch(console.log).finally(()=>qrScanner=null);
  scanModal.style.display = "none";
}

// ===== PROCESAR CLIENTE =====
function procesarCliente(idCliente) {
  if(!idCliente) { showToast("ID de cliente invÃ¡lido."); return; }
  const NEGOCIO_ID = "restaurante1";
  const clienteRef = firebase.database().ref(`negocios/${NEGOCIO_ID}/clientes/${idCliente}`);

  clienteRef.get().then(snapshot => {
    if(!snapshot.exists()) {
      // Nuevo cliente
      nuevoClienteData = {idCliente, ref: clienteRef};
      nuevoClienteModal.style.display = "flex";
    } else {
      // Cliente existente
      let cliente = snapshot.val();
      let visitas = (cliente.visitas||0)+1;
      let nombre = cliente.nombre||"Cliente";
      let cumple = cliente.cumpleanos||null;
      let recompensaEntregada = cliente.recompensaEntregada||false;
      let cumplePendiente = cliente.cumplePendiente||false;

      clienteRef.update({visitas}).then(()=>{
        mostrarEstado(idCliente, nombre, visitas);

        // CumpleaÃ±os
        if(cumple && visitas>=3){
          const hoy=new Date();
          const cumpleDate=new Date(cumple);
          if(hoy.getMonth()===cumpleDate.getMonth() && hoy.getDate()===cumpleDate.getDate() && !cumplePendiente){
            showToast(`ðŸŽ‚ Â¡Feliz cumpleaÃ±os, ${nombre}!`);
            clienteRef.update({cumplePendiente:true});
          }
        }

        // Recompensa
        if(visitas>=6 && !recompensaEntregada){
          mostrarConfeti();
          showToast(`ðŸŽ‰ Â¡Felicidades ${nombre}! Recompensa completada.`);
          clienteRef.update({visitas:0, recompensaEntregada:true});
        }
      }).catch(err=>showToast("Error actualizando cliente."));
    }
  }).catch(err=>{
    statusDiv.innerText="Error: "+err;
    showToast("Error conectando a la base de datos.");
  });
}

// ===== MOSTRAR ESTADO =====
function mostrarEstado(idCliente,nombre,visitas){
  statusDiv.innerHTML=`${nombre} (ID: <b>${idCliente}</b>)<br>Visitas acumuladas: <b>${visitas}/6</b>`;
}

// ===== CONFETI =====
function mostrarConfeti(){
  confetti({particleCount:150,spread:70,origin:{y:0.6}});
}

// ===== GUARDAR CLIENTE NUEVO =====
function guardarCliente(){
  const nombre=document.getElementById("nombreInput").value.trim();
  const cumple=document.getElementById("cumpleInput").value;

  if(!nombre){ showToast("Por favor ingresa tu nombre."); return; }

  if(!nuevoClienteData.ref || !nuevoClienteData.idCliente){
    showToast("Error al guardar cliente."); 
    return;
  }

  nuevoClienteData.ref.set({
    nombre,
    cumpleanos: cumple||null,
    visitas:1,
    recompensaEntregada:false,
    cumplePendiente:false
  }).then(()=>{
    mostrarEstado(nuevoClienteData.idCliente,nombre,1);
    cerrarNuevoClienteModal();
    showToast("Cliente registrado con Ã©xito!");
  }).catch(()=>showToast("Error guardando cliente."));
}

// ===== CERRAR MODAL NUEVO CLIENTE =====
function cerrarNuevoClienteModal(){
  nuevoClienteModal.style.display="none";
  document.getElementById("nombreInput").value="";
  document.getElementById("cumpleInput").value="";
}
</script>

</body>
</html>
