<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registrar Visita</title>

  <!-- QR Scanner -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
    body {
      margin: 0;
      height: 100vh;
      background-image: url("https://images.unsplash.com/photo-1521017432531-fbd92d768814");
      background-size: cover;
      background-position: center;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.55); }
    .card {
      position: relative; z-index: 2;
      background: #00754A;
      width: 90%; max-width: 380px;
      padding: 35px 30px;
      border-radius: 18px;
      text-align: center;
      color: white;
    }
    .negocio { font-size: 22px; font-weight: 600; margin-bottom: 10px; }
    h1 { font-size: 24px; margin-bottom: 10px; }
    p { font-size: 15px; }
    button {
      width: 100%;
      margin-top: 25px;
      padding: 16px;
      font-size: 18px;
      border: none;
      border-radius: 12px;
      background: white;
      color: #00754A;
      cursor: pointer;
    }
    #status { margin-top: 20px; min-height: 22px; font-size: 16px; }

    /* ===== MODAL ESC√ÅNER ===== */
    .scan-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .scanner-container { position: relative; width: 280px; height: 280px; }
    #reader { width: 100%; height: 100%; border-radius: 16px; overflow: hidden; }
    .scan-frame {
      position: absolute; inset: 0;
      border: 3px solid rgba(255,255,255,0.9);
      border-radius: 16px;
      pointer-events: none;
    }
    .scan-line {
      position: absolute;
      left: 0; right: 0;
      height: 2px;
      background: #00ff9d;
      animation: scan 2s linear infinite;
    }
    @keyframes scan { from { top: 10%; } to { top: 90%; } }
    .scan-text { margin-top: 15px; color: white; font-size: 14px; text-align: center; }
    .btn-cancel {
      margin-top: 18px;
      background: #ffffff;
      color: #333;
      border-radius: 10px;
      padding: 12px;
      border: none;
      width: 100%;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div class="overlay"></div>

  <div class="card">
    <div class="negocio">Restaurante Buon Appetito</div>
    <h1>Registrar Visita</h1>
    <p>Escanear el QR del cliente</p>

    <button id="scanBtn">üì∑ Escanear QR</button>
    <div id="status"></div>

    <button
      id="btnEntregar"
      style="
        display:none;
        margin-top:15px;
        background:#FFD700;
        color:#333;
        font-weight:bold;
        border:none;
        border-radius:12px;
        padding:14px;
        cursor:pointer;
      ">
      üéÅ Entregar recompensa
    </button>
  </div>
<button
  id="btnResetFirebase"
  style="
    display:none;
    margin-top:12px;
    background:#b30000;
    color:#fff;
    font-weight:800;
    border:none;
    border-radius:12px;
    padding:14px;
    cursor:pointer;
  "
>
  üß™ Borrar cliente en Firebase (solo pruebas)
</button>
  <!-- MODAL ESC√ÅNER -->
  <div id="scanModal" class="scan-modal">
    <div>
      <div class="scanner-container">
        <div id="reader"></div>
        <div class="scan-frame"></div>
        <div class="scan-line"></div>
      </div>
      <div class="scan-text">Coloca el QR dentro del marco</div>
      <button class="btn-cancel" onclick="cerrarEscaner()">Cancelar</button>
    </div>
  </div>

  <!-- Sonidos (igual que ya ten√≠as) -->
  <audio id="soundCanje" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3" preload="auto"></audio>
  <audio id="soundCumple" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" preload="auto"></audio>
  <audio id="soundSix" src="https://assets.mixkit.co/active_storage/sfx/270/270-preview.mp3" preload="auto"></audio>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

  <script>
    const params = new URLSearchParams(location.search);
const NEGOCIO_ID = params.get("negocio") || "restaurante1";

    const firebaseConfig = {
      apiKey: "AIzaSyBbFAbpOJvhBu_QR16Ep7WfRqcLaHW1F1s",
      authDomain: "cliente-lealtad.firebaseapp.com",
      databaseURL: "https://cliente-lealtad-default-rtdb.firebaseio.com",
      projectId: "cliente-lealtad",
      storageBucket: "cliente-lealtad.firebasestorage.app",
      messagingSenderId: "19568539350",
      appId: "1:19568539350:web:0f545162141039a376bb77",
      measurementId: "G-6GP76P39G8"
    };
    firebase.initializeApp(firebaseConfig);

    const scanBtn = document.getElementById("scanBtn");
    const scanModal = document.getElementById("scanModal");
    const statusDiv = document.getElementById("status");
    const btnEntregar = document.getElementById("btnEntregar");

    let qrScanner = null;

    // Anti doble-escaneo
    let cooldownActivo = false;
    const COOLDOWN_MS = 2500;

    // Cliente actual (para canje)
    let clienteActual = null; // { negocioId, idCliente, nombre, ref }

    function playSound(id) {
      const a = document.getElementById(id);
      if (!a) return;
      a.currentTime = 0;
      a.play().catch(() => {});
    }

    function setCajeroAnim(isOn) {
      if (!btnEntregar) return;
      if (isOn) btnEntregar.classList.add("btn-cajero-anim");
      else btnEntregar.classList.remove("btn-cajero-anim");
    }

    // ===== ESCANEAR QR =====
    scanBtn.addEventListener("click", () => {
      scanModal.style.display = "flex";

      qrScanner = new Html5Qrcode("reader");
      qrScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 220 },
        (qrText) => {
          cerrarEscaner();

          const raw = (qrText || "").trim();
          if (!raw) return alert("QR inv√°lido. Intenta de nuevo.");

          // Formato esperado: negocio|idCliente
          const parts = raw.split("|");
          if (parts.length !== 2) return alert("QR inv√°lido. Debe ser formato NEGOCIO|CLIENTE.");

          const negocioId = parts[0].trim();
          const idCliente = parts[1].trim();
          if (!negocioId || !idCliente) return alert("QR inv√°lido.");

          procesarCliente(negocioId, idCliente);
        }
      ).catch(err => {
        console.log("Error al iniciar c√°mara:", err);
        scanModal.style.display = "none";
      });
    });
// üîí Validaci√≥n por negocio (activar cuando haya m√∫ltiples negocios reales)
// if (negocioId !== NEGOCIO_ID) {
//   alert("Este QR no pertenece a este negocio");
//   return;
// }

procesarCliente(negocioId, idCliente);

    function cerrarEscaner() {
      if (qrScanner) {
        qrScanner.stop()
          .then(() => qrScanner.clear())
          .catch(err => console.log("Error cerrando c√°mara:", err))
          .finally(() => qrScanner = null);
      }
      scanModal.style.display = "none";
    }

    // ===== BOT√ìN CAJERO: ENTREGAR RECOMPENSA =====
    btnEntregar.addEventListener("click", () => {
      if (!clienteActual || !clienteActual.ref) return;

      const ref = clienteActual.ref;

      ref.get().then(snap => {
        if (!snap.exists()) return;

        const cliente = snap.val();
        const nombre = cliente.nombre || "Cliente";
        const recompensasPrevias = cliente.recompensasTotales || 0;

        const ok = confirm(`¬øConfirmas entregar la recompensa a ${nombre}?`);
        if (!ok) return;

        ref.update({
          visitas: 0,
          recompensaPendiente: false,
          recompensasTotales: recompensasPrevias + 1
        }).then(() => {
          playSound("soundCanje");
          alert(`‚úÖ Recompensa entregada a ${nombre}.`);
          mostrarEstado(clienteActual.idCliente, nombre, 0, recompensasPrevias + 1, false);
          clienteActual = null;
        });
      });
    });

    function mostrarConfeti() {
      confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
    }

    function mostrarEstado(idCliente, nombre, visitas, recompensasTotales = 0, recompensaPendiente = false) {
      statusDiv.innerHTML = `
        ${nombre} (ID: <b>${idCliente}</b>)<br>
        Visitas acumuladas: <b>${visitas}/6</b><br>
        üèÜ Recompensas canjeadas: <b>${recompensasTotales}</b>
        ${recompensaPendiente ? "<br>üéÅ <b>Recompensa lista para canjear</b>" : ""}
      `;
      btnEntregar.style.display = recompensaPendiente ? "block" : "none";
      setCajeroAnim(recompensaPendiente);
    }

    // ===== PROCESAR CLIENTE (solo EXISTENTE) =====
    function procesarCliente(negocioId, idCliente) {
      if (cooldownActivo) return;
      cooldownActivo = true;
      setTimeout(() => cooldownActivo = false, COOLDOWN_MS);

      const clienteRef = firebase.database().ref(`negocios/${negocioId}/clientes/${idCliente}`);

      clienteRef.get().then(snapshot => {
        if (!snapshot.exists()) {
          alert("Cliente no encontrado. Debe registrarse con el QR del negocio primero.");
          return;
        }

        const cliente = snapshot.val();

        let visitasActuales = cliente.visitas || 0;
        const nombre = cliente.nombre || "Cliente";
        const cumple = cliente.cumpleanos || null;

        const recompensasTotales = cliente.recompensasTotales || 0;
        const recompensaPendiente = cliente.recompensaPendiente || false;

        // Si hay pendiente: no sumar, solo mostrar
        if (recompensaPendiente) {
          clienteActual = { negocioId, idCliente, nombre, ref: clienteRef };
          mostrarEstado(idCliente, nombre, visitasActuales, recompensasTotales, true);
          alert(`üéâ Felicidades ${nombre}, mu√©stralo al cajero para cambiar tu recompensa`);
          return;
        }

        // Suma visita
        visitasActuales += 1;

        clienteRef.update({ visitas: visitasActuales }).then(() => {
          mostrarEstado(idCliente, nombre, visitasActuales, recompensasTotales, false);

          // Cumplea√±os (1 vez por a√±o)
          if (cumple) {
            const hoy = new Date();
            const cumpleDate = new Date(cumple);

            const mismoDia =
              hoy.getMonth() === cumpleDate.getMonth() &&
              hoy.getDate() === cumpleDate.getDate();

            const anio = hoy.getFullYear();
            const yaMostrado = cliente.cumpleMostradoAnio === anio;

            if (mismoDia && !yaMostrado) {
              playSound("soundCumple");
              alert(`üéÇ ¬°Feliz cumplea√±os, ${nombre}! Tienes un regalo especial hoy.`);
              clienteRef.update({ cumpleMostradoAnio: anio });
            }
          }

          // Si lleg√≥ a 6: pendiente + confeti + sonido
          if (visitasActuales >= 6) {
            clienteActual = { negocioId, idCliente, nombre, ref: clienteRef };

            clienteRef.update({ recompensaPendiente: true }).then(() => {
              playSound("soundSix");
              mostrarConfeti();
              mostrarEstado(idCliente, nombre, visitasActuales, recompensasTotales, true);
              setCajeroAnim(true);
              alert(`üéâ ${nombre}, ¬°llegaste a tu recompensa!\nMu√©stralo al cajero para canjearla ‚úÖ`);
            });

            return;
          }
        });
      }).catch(err => {
        statusDiv.innerText = "Error: " + err;
      });
    }
  </script>
  <script>
  // ===== DEBUG ON SOLO CON ?debug=1 =====
  const DEBUG = new URLSearchParams(location.search).get("debug") === "1";

  (function () {
    const btn = document.getElementById("btnResetFirebase");
    if (!btn) return;

    if (DEBUG) btn.style.display = "block";

    btn.addEventListener("click", async () => {
      // Requiere que tengas "clienteActual = { idCliente, nombre, ref }" como en tu c√≥digo
      if (!window.clienteActual || !clienteActual.ref) {
        alert("Primero escanea un cliente para seleccionar a qui√©n borrar.");
        return;
      }

      const nombre = clienteActual.nombre || "Cliente";
      const id = clienteActual.idCliente || "(sin id)";

      const ok = confirm(
        `üß™ BORRADO REAL (Firebase)\n\nEsto elimina el registro del cliente:\n${nombre} (${id})\n\n¬øContinuar?`
      );
      if (!ok) return;

      try {
        // Borra el nodo completo del cliente en Firebase
        await clienteActual.ref.remove();

        alert(`‚úÖ Eliminado en Firebase: ${nombre} (${id}).`);

        // Limpia estado de pantalla si tienes statusDiv/mostrarEstado
        if (typeof statusDiv !== "undefined" && statusDiv) statusDiv.innerHTML = "";
        if (typeof btnEntregar !== "undefined" && btnEntregar) btnEntregar.style.display = "none";

        clienteActual = null;
      } catch (e) {
        alert("Error borrando en Firebase: " + e);
      }
    });
  })();
</script>
</body>
</html>
