<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registrar Visita</title>

  <!-- QR Scanner -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    * {
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body {
      margin: 0;
      height: 100vh;
      background-image: url("https://images.unsplash.com/photo-1521017432531-fbd92d768814");
      background-size: cover;
      background-position: center;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
    }

    .card {
      position: relative;
      z-index: 2;
      background: #00754A;
      width: 90%;
      max-width: 380px;
      padding: 35px 30px;
      border-radius: 18px;
      text-align: center;
      color: white;
    }

    .negocio {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 10px;
    }

    p {
      font-size: 15px;
    }

    button {
      width: 100%;
      margin-top: 25px;
      padding: 16px;
      font-size: 18px;
      border: none;
      border-radius: 12px;
      background: white;
      color: #00754A;
      cursor: pointer;
    }

    #status {
      margin-top: 20px;
      min-height: 22px;
      font-size: 16px;
    }

    /* ===== MODAL ESC√ÅNER ===== */

    .scan-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .scanner-container {
      position: relative;
      width: 280px;
      height: 280px;
    }

    #reader {
      width: 100%;
      height: 100%;
      border-radius: 16px;
      overflow: hidden;
    }

    .scan-frame {
      position: absolute;
      inset: 0;
      border: 3px solid rgba(255,255,255,0.9);
      border-radius: 16px;
      pointer-events: none;
    }

    .scan-line {
      position: absolute;
      left: 0;
      right: 0;
      height: 2px;
      background: #00ff9d;
      animation: scan 2s linear infinite;
    }

    @keyframes scan {
      from { top: 10%; }
      to { top: 90%; }
    }

    .scan-text {
      margin-top: 15px;
      color: white;
      font-size: 14px;
      text-align: center;
    }

    .btn-cancel {
      margin-top: 18px;
      background: #ffffff;
      color: #333;
      border-radius: 10px;
      padding: 12px;
      border: none;
      width: 100%;
      cursor: pointer;
    }
  </style>
</head>

<body>

  <div class="overlay"></div>

 <div class="card">
  <div class="negocio">Restaurante Buon Appetito</div>
  <h1>Registrar Visita</h1>
  <p>Escanear el QR del cliente</p>

  <button id="scanBtn">üì∑ Escanear QR</button>
  <div id="status"></div>
  <!-- BOT√ìN CAJERO: ENTREGAR RECOMPENSA -->
<button
  id="btnEntregar"
  style="
    display:none;
    margin-top:15px;
    background:#FFD700;
    color:#333;
    font-weight:bold;
    border:none;
    border-radius:12px;
    padding:14px;
    cursor:pointer;
  ">
  üéÅ Entregar recompensa
</button>

</div>

<!-- MODAL ESC√ÅNER -->
<div id="scanModal" class="scan-modal">
  <div>
    <div class="scanner-container">
      <div id="reader"></div>
      <div class="scan-frame"></div>
      <div class="scan-line"></div>
    </div>
    <div class="scan-text">Coloca el QR dentro del marco</div>
    <button class="btn-cancel" onclick="cerrarEscaner()">Cancelar</button>
  </div>
</div>

<!-- MODAL NUEVO CLIENTE -->

<div id="nuevoClienteModal" class="scan-modal">
  <div style="background:#00754A; padding:30px; border-radius:18px; text-align:center; color:white; max-width:350px; margin:auto;">
    
    <h2>¬°Bienvenido!</h2>
    <p>Ingresa tu informaci√≥n para registrar tu visita</p>

    <!-- Nombre -->
    <label style="display:block; text-align:left; margin:10px 0 5px;">
      Nombre completo
    </label>
    <input
      type="text"
      id="nombreInput"
      style="width:90%; padding:10px; border-radius:8px; border:none;"
    >

    <!-- Fecha de nacimiento -->
    <label style="display:block; text-align:left; margin:10px 0 5px;">
      Fecha de nacimiento
    </label>
    <input
      type="date"
      id="cumpleInput"
      style="width:90%; padding:10px; border-radius:8px; border:none;"
    >

    <!-- Bot√≥n Guardar -->
    <button
      onclick="guardarCliente()"
      style="padding:12px 20px; margin-top:15px; border:none; border-radius:10px; background:white; color:#00754A; font-weight:bold; cursor:pointer;">
      Guardar
    </button>

    <!-- Bot√≥n Cancelar -->
    <button
      onclick="cerrarNuevoClienteModal()"
      style="padding:12px 20px; margin-top:10px; border:none; border-radius:10px; background:#ffffff; color:#333; font-weight:bold; cursor:pointer;">
      Cancelar
    </button>
     <!-- ayuda a los sonidos de recompenzas -->

<audio id="soundCanje" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3" preload="auto"></audio>
<audio id="soundCumple" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" preload="auto"></audio>
<audio id="soundSix" src="https://assets.mixkit.co/active_storage/sfx/270/270-preview.mp3" preload="auto"></audio>

  </div>
</div>



<!-- Firebase App (el n√∫cleo de Firebase) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<!-- Firebase Database -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Confetti -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

<script>
  // ===== CONFIGURACI√ìN FIREBASE =====
  const firebaseConfig = {
    apiKey: "AIzaSyBbFAbpOJvhBu_QR16Ep7WfRqcLaHW1F1s",
    authDomain: "cliente-lealtad.firebaseapp.com",
    databaseURL: "https://cliente-lealtad-default-rtdb.firebaseio.com",
    projectId: "cliente-lealtad",
    storageBucket: "cliente-lealtad.firebasestorage.app",
    messagingSenderId: "19568539350",
    appId: "1:19568539350:web:0f545162141039a376bb77",
    measurementId: "G-6GP76P39G8"
  };
  firebase.initializeApp(firebaseConfig);

  // ===== DOM =====
  const scanBtn = document.getElementById("scanBtn");
  const scanModal = document.getElementById("scanModal");
  const statusDiv = document.getElementById("status");
  const nuevoClienteModal = document.getElementById("nuevoClienteModal");
  const btnEntregar = document.getElementById("btnEntregar");

  let qrScanner = null;
  let nuevoClienteData = {};

  // Anti doble-escaneo
  let cooldownActivo = false;
  const COOLDOWN_MS = 2500;

  // Cliente actual (para que el cajero confirme)
  let clienteActual = null; // { idCliente, nombre, ref }

  // üîä Reproducir sonido seguro (evita errores si el navegador bloquea autoplay)
function playSound(id) {
  const a = document.getElementById(id);
  if (!a) return;
  a.currentTime = 0;
  a.play().catch(() => {});
}

// üé® Activar/Desactivar animaci√≥n del bot√≥n del cajero
function setCajeroAnim(isOn) {
  if (!btnEntregar) return;
  if (isOn) btnEntregar.classList.add("btn-cajero-anim");
  else btnEntregar.classList.remove("btn-cajero-anim");
}


  // ===== ESCANEAR QR =====
  scanBtn.addEventListener("click", () => {
    scanModal.style.display = "flex";

    qrScanner = new Html5Qrcode("reader");
    qrScanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 220 },
      (qrText) => {
        cerrarEscaner();
        const idCliente = (qrText || "").trim();
        if (!idCliente) return alert("QR inv√°lido. Intenta de nuevo.");
        procesarCliente(idCliente);
      }
    ).catch(err => {
      console.log("Error al iniciar c√°mara:", err);
      scanModal.style.display = "none";
    });
  });

  // ===== CERRAR ESCANER =====
  function cerrarEscaner() {
    if (qrScanner) {
      qrScanner.stop()
        .then(() => qrScanner.clear())
        .catch(err => console.log("Error cerrando c√°mara:", err))
        .finally(() => qrScanner = null);
    }
    scanModal.style.display = "none";
  }

  // ===== BOT√ìN CAJERO: ENTREGAR RECOMPENSA =====
  btnEntregar.addEventListener("click", () => {
    if (!clienteActual || !clienteActual.ref) return;

    const ref = clienteActual.ref;

    ref.get().then(snap => {
      if (!snap.exists()) return;

      const cliente = snap.val();
      const nombre = cliente.nombre || "Cliente";
      const recompensasPrevias = cliente.recompensasTotales || 0;

      // CONFIRMA ENTREGA (opcional)
      const ok = confirm(`¬øConfirmas entregar la recompensa a ${nombre}?`);
      if (!ok) return;

      // Entrega: suma recompensa + reinicia ciclo + quita pendiente
   ref.update({
  visitas: 0,
  recompensaPendiente: false,
  recompensasTotales: recompensasPrevias + 1
}).then(() => {

  playSound("soundCanje");

  alert(`‚úÖ Recompensa entregada a ${nombre}.`);
  mostrarEstado(clienteActual.idCliente, nombre, 0, recompensasPrevias + 1, false);
  clienteActual = null;
});
    });
  });

  // ===== PROCESAR CLIENTE =====
  function procesarCliente(idCliente) {
    // Anti-spam: evita sumar si el lector dispara varias veces
    if (cooldownActivo) return;
    cooldownActivo = true;
    setTimeout(() => cooldownActivo = false, COOLDOWN_MS);

    const NEGOCIO_ID = "restaurante1";
    const clienteRef = firebase.database().ref(`negocios/${NEGOCIO_ID}/clientes/${idCliente}`);

    clienteRef.get().then(snapshot => {
      // ===== CLIENTE NUEVO =====
      if (!snapshot.exists()) {
        nuevoClienteModal.style.display = "flex";
        nuevoClienteData.idCliente = idCliente;
        nuevoClienteData.ref = clienteRef;
        return;
      }

      // ===== CLIENTE EXISTENTE =====
      const cliente = snapshot.val();

      let visitasActuales = cliente.visitas || 0;
      const nombre = cliente.nombre || "Cliente";
      const cumple = cliente.cumpleanos || null;

      const recompensasTotales = cliente.recompensasTotales || 0;
      const recompensaPendiente = cliente.recompensaPendiente || false;

      // ‚úÖ Si ya hay recompensa pendiente: NO sumar visitas
      if (recompensaPendiente) {
        clienteActual = { idCliente, nombre, ref: clienteRef };
        mostrarEstado(idCliente, nombre, visitasActuales, recompensasTotales, true);
       alert(`üéâ Felicidades ${nombre}, mu√©stralo al cajero para cambiar tu recompensa`);

        return;
      }

      // ‚úÖ Suma visita normal
      visitasActuales += 1;

      clienteRef.update({ visitas: visitasActuales }).then(() => {
        mostrarEstado(idCliente, nombre, visitasActuales, recompensasTotales, false);

        // üéÇ Cumplea√±os (si quieres)
     // üéÇ Cumplea√±os (solo 1 vez por a√±o)
if (cumple) {
  const hoy = new Date();
  const cumpleDate = new Date(cumple);

  const mismoDia =
    hoy.getMonth() === cumpleDate.getMonth() &&
    hoy.getDate() === cumpleDate.getDate();

  const anio = hoy.getFullYear();
  const yaMostrado = cliente.cumpleMostradoAnio === anio;

  if (mismoDia && !yaMostrado) {
     playSound("soundCumple");
    alert(`üéÇ ¬°Feliz cumplea√±os, ${nombre}! Tienes un regalo especial hoy.`);
    clienteRef.update({ cumpleMostradoAnio: anio });
  }
}


        // ‚úÖ Si lleg√≥ a 6: marca pendiente (NO reinicia todav√≠a)
        if (visitasActuales >= 6) {
          clienteActual = { idCliente, nombre, ref: clienteRef };

         clienteRef.update({ recompensaPendiente: true }).then(() => {
    playSound("soundSix");      // üîä suave 6/6
    mostrarConfeti();           // üéâ confeti
    mostrarEstado(idCliente, nombre, visitasActuales, recompensasTotales, true);

    // üé® animaci√≥n cajero ON
    setCajeroAnim(true);
            alert(`üéâ ${nombre}, ¬°llegaste a tu recompensa!\nMu√©stralo al cajero para canjearla ‚úÖ`);
          });

          return;
        }
      });

    }).catch(err => {
      statusDiv.innerText = "Error: " + err;
    });
  }

  // ===== MOSTRAR ESTADO =====
  function mostrarEstado(idCliente, nombre, visitas, recompensasTotales = 0, recompensaPendiente = false) {
    statusDiv.innerHTML = `
      ${nombre} (ID: <b>${idCliente}</b>)<br>
      Visitas acumuladas: <b>${visitas}/6</b><br>
      üèÜ Recompensas canjeadas: <b>${recompensasTotales}</b>
      ${recompensaPendiente ? "<br>üéÅ <b>Recompensa lista para canjear</b>" : ""}
    `;

    // Bot√≥n del cajero SOLO si hay pendiente
    btnEntregar.style.display = recompensaPendiente ? "block" : "none";
    setCajeroAnim(recompensaPendiente);
  }

  // ===== CONFETI =====
  function mostrarConfeti() {
    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
  }

  // ===== GUARDAR CLIENTE NUEVO =====
  function guardarCliente() {
    const nombre = (document.getElementById("nombreInput").value || "Cliente").trim();
    const cumple = document.getElementById("cumpleInput").value || null;
    const clienteRef = nuevoClienteData.ref;

    clienteRef.set({
      nombre: nombre,
      cumpleanos: cumple,
      visitas: 1,
      recompensaPendiente: false,
      recompensasTotales: 0
    }).then(() => {
      mostrarEstado(nuevoClienteData.idCliente, nombre, 1, 0, false);
      nuevoClienteModal.style.display = "none";
      document.getElementById("nombreInput").value = "";
      document.getElementById("cumpleInput").value = "";
    });
  }

  // ===== CERRAR MODAL NUEVO CLIENTE =====
  function cerrarNuevoClienteModal() {
    nuevoClienteModal.style.display = "none";
    document.getElementById("nombreInput").value = "";
    document.getElementById("cumpleInput").value = "";
  }

  </script>

</body>
</html>
