<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registro ‚Ä¢ Cliente</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#00754A">

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <!-- QR generator -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>


  <style>
    * { box-sizing:border-box; font-family:'Poppins',sans-serif; }
    body {
      margin:0; height:100vh;
      background-image:url("https://images.unsplash.com/photo-1521017432531-fbd92d768814");
      background-size:cover; background-position:center;
      display:flex; justify-content:center; align-items:center;
    }
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,0.55); }
    .card{
      position:relative; z-index:2;
      background:#00754A; width:90%; max-width:380px;
      padding:35px 30px; border-radius:18px; text-align:center; color:white;
    }
    .negocio{ font-size:22px; font-weight:600; margin-bottom:10px; }
    h1{ font-size:22px; margin:10px 0 8px; }
    p{ font-size:14px; margin:0 0 10px; opacity:.95; }
    label{ display:block; text-align:left; margin:10px 0 5px; font-size:14px; }
    input{
      width:100%; padding:12px; border-radius:10px; border:none; outline:none;
      font-size:15px;
    }
    button{
      width:100%; margin-top:14px; padding:14px;
      font-size:16px; border:none; border-radius:12px;
      background:white; color:#00754A; cursor:pointer; font-weight:600;
    }
    .btn-sec{
      background:#ffffff; color:#333; font-weight:600;
    }
    #status{ margin-top:12px; min-height:22px; font-size:14px; }
    .box{
      margin-top:14px; background:rgba(255,255,255,0.12);
      border-radius:14px; padding:14px;
    }
    #qrWrap{ display:flex; justify-content:center; margin-top:10px; }
    #qr{ background:#fff; padding:10px; border-radius:12px; }
    .small{ font-size:12px; opacity:.95; margin-top:10px; line-height:1.35; }
    .link{
      color:#fff; text-decoration:underline; cursor:pointer;
    }
  </style>
</head>

<body>
  <div class="overlay"></div>

  <div class="card">
    <div class="negocio" id="negocioTitulo">Registro</div>

    <div id="vistaRegistro">
      <h1>Reg√≠strate una sola vez</h1>
      <p>Despu√©s tu QR personal quedar√° guardado.</p>

      <label>Nombre completo</label>
      <input id="nombreInput" type="text" placeholder="Ej. Mar√≠a P√©rez" />

      <label>Fecha de nacimiento</label>
      <input id="cumpleInput" type="date" />

      <label>N√∫mero de tel√©fono (recuperaci√≥n)</label>
      <input id="telInput" type="tel" placeholder="Ej. 5512345678" inputmode="tel" />

      <label>Correo electr√≥nico (recuperaci√≥n)</label>
      <input id="emailInput" type="email" placeholder="Ej. maria@email.com" inputmode="email" />

      <button type="button" id="btnCrear">Crear mi QR</button>


      <div class="small">
        Si ya te registraste y cambiaste de tel√©fono:
        <span class="link" id="goRecuperar">recuperar mi QR</span>
      </div>
      <button
  id="btnResetLocal"
  style="
    display:none;
    margin-top:12px;
    background:#ff4d4d;
    color:#fff;
    font-weight:700;
    border:none;
    border-radius:12px;
    padding:14px;
    cursor:pointer;
  "
>
  üß™ Reset (solo pruebas)
</button>

      <div id="status"></div>
    </div>

    <div id="vistaQR" style="display:none;">
      <h1>Este es tu QR personal</h1>
      <p>Gu√°rdalo. Lo mostrar√°s en cada visita.</p>

      <div class="box">
        <div><b id="nombreMostrado">Cliente</b></div>
        <div class="small">Visitas: <b id="visitasTxt">0/6</b> ‚Ä¢ Recompensas: <b id="recompTxt">0</b></div>

        <div id="qrWrap"><div id="qr"></div></div>

        <button id="btnGuardarApp">üì≤ Guardar como app</button>
        <button class="btn-sec" id="btnScreenshot">üñºÔ∏è Tomar screenshot (recomendado)</button>

        <div class="small" id="ayudaApp" style="display:none;">
          <b>iPhone:</b> Safari ‚Üí Compartir ‚Üí ‚ÄúAgregar a pantalla de inicio‚Äù.<br>
          <b>Android:</b> Chrome ‚Üí Men√∫ (‚ãÆ) ‚Üí ‚ÄúAgregar a pantalla principal‚Äù.
        </div>

        <div class="small" style="margin-top:10px;">
          Tu QR identifica tu cuenta. Si lo pierdes, usa ‚Äúrecuperar‚Äù con tu tel√©fono y correo.
        </div>
      </div>

      <div id="status2" style="margin-top:10px; font-size:14px;"></div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // ===== CONFIG FIREBASE (TU MISMO) =====
    const firebaseConfig = {
      apiKey: "AIzaSyBbFAbpOJvhBu_QR16Ep7WfRqcLaHW1F1s",
      authDomain: "cliente-lealtad.firebaseapp.com",
      databaseURL: "https://cliente-lealtad-default-rtdb.firebaseio.com",
      projectId: "cliente-lealtad",
      storageBucket: "cliente-lealtad.firebasestorage.app",
      messagingSenderId: "19568539350",
      appId: "1:19568539350:web:0f545162141039a376bb77",
      measurementId: "G-6GP76P39G8"
    };
    firebase.initializeApp(firebaseConfig);

    // ===== NEGOCIO desde URL =====
    const params = new URLSearchParams(location.search);
    const NEGOCIO_ID = params.get("negocio") || "restaurante1";
  document.getElementById("negocioTitulo").innerText =
  "Bienvenido a Restaurante Buon Appetito";


    // ===== PWA register =====
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    }

    // ===== Helpers =====
    const status = document.getElementById("status");
    const status2 = document.getElementById("status2");

    function normEmail(v){ return (v||"").trim().toLowerCase(); }
    function normTel(v){ return (v||"").replace(/[^\d]/g,"").trim(); }

    function makeId(){
      // idCliente simple (suficiente). Si quieres m√°s robusto luego usamos push().key
      return "c_" + Math.random().toString(36).slice(2,10) + Date.now().toString(36);
    }

    function showQRView({idCliente, nombre, visitas=0, recompensasTotales=0}){
      document.getElementById("vistaRegistro").style.display = "none";
      document.getElementById("vistaQR").style.display = "block";
      document.getElementById("nombreMostrado").innerText = nombre || "Cliente";
      document.getElementById("visitasTxt").innerText = `${visitas}/6`;
      document.getElementById("recompTxt").innerText = `${recompensasTotales}`;

      // Render QR
      const qrDiv = document.getElementById("qr");
      qrDiv.innerHTML = "";
      new QRCode(qrDiv, {
        text: idCliente, width: 210, height: 210
      });

      // Guarda en localStorage para ‚Äúrecordar‚Äù en este mismo tel√©fono
      localStorage.setItem(`cliente_id_${NEGOCIO_ID}`, idCliente);
      localStorage.setItem(`cliente_nombre_${NEGOCIO_ID}`, nombre || "Cliente");
    }

    // Si ya hab√≠a guardado su id en ESTE tel√©fono, mu√©stralo sin volver a registrarse
    (function autoLoadIfExists(){
      const saved = localStorage.getItem(`cliente_id_${NEGOCIO_ID}`);
      if (!saved) return;
      const ref = firebase.database().ref(`negocios/${NEGOCIO_ID}/clientes/${saved}`);
      ref.get().then(snap=>{
        if (!snap.exists()) return;
        const c = snap.val() || {};
        showQRView({
          idCliente: saved,
          nombre: c.nombre || "Cliente",
          visitas: c.visitas || 0,
          recompensasTotales: c.recompensasTotales || 0
        });
        status2.innerText = "QR cargado desde tu dispositivo.";
      }).catch(()=>{});
    })();

    // ===== Crear cliente =====
    document.getElementById("btnCrear").addEventListener("click", async () => {
      status.innerText = "";

      const nombre = (document.getElementById("nombreInput").value || "").trim();
      const cumple = document.getElementById("cumpleInput").value || null;
      const tel = normTel(document.getElementById("telInput").value);
      const email = normEmail(document.getElementById("emailInput").value);

      if (!nombre) return (status.innerText = "Ingresa tu nombre.");
      if (!tel) return (status.innerText = "Ingresa tu tel√©fono (recuperaci√≥n).");
      if (!email) return (status.innerText = "Ingresa tu correo (recuperaci√≥n).");

      // Crea cliente
      const idCliente = makeId();
      const clienteRef = firebase.database().ref(`negocios/${NEGOCIO_ID}/clientes/${idCliente}`);

      // √çndice para recuperaci√≥n (nivel 1 sin OTP): email+tel ‚Üí idCliente
      const idxKey = (email + "_" + tel);
      const idxRef = firebase.database().ref(`negocios/${NEGOCIO_ID}/recoveryIndex/${idxKey}`);

      try{
        await clienteRef.set({
          nombre,
          cumpleanos: cumple,
          telefono: tel,
          email: email,
          visitas: 0,
          recompensaPendiente: false,
          recompensasTotales: 0,
          creadoEn: Date.now()
        });

        await idxRef.set({ idCliente, creadoEn: Date.now() });

        showQRView({ idCliente, nombre, visitas: 0, recompensasTotales: 0 });
        status2.innerText = "Listo. Guarda tu QR para usarlo en cada visita.";

      }catch(e){
        status.innerText = "Error: " + e.message;
      }
    });

    // ===== Bot√≥n ‚ÄúGuardar como app‚Äù (instrucciones) =====
    document.getElementById("btnGuardarApp").addEventListener("click", () => {
      document.getElementById("ayudaApp").style.display = "block";
    });

    // ===== Bot√≥n screenshot (solo instrucci√≥n) =====
    document.getElementById("btnScreenshot").addEventListener("click", () => {
      alert("Haz screenshot a tu QR para guardarlo en tu galer√≠a. Luego lo muestras en cada visita.");
    });

    // Ir a recuperar
    document.getElementById("goRecuperar").addEventListener("click", () => {
      location.href = `./recuperar.html?negocio=${encodeURIComponent(NEGOCIO_ID)}`;
    });
  </script>
  <script>
  // ===== DEBUG ON SOLO CON ?debug=1 =====
  const DEBUG = new URLSearchParams(location.search).get("debug") === "1";

  // Muestra el bot√≥n solo en debug
  (function () {
    const btn = document.getElementById("btnResetLocal");
    if (!btn) return;

    if (DEBUG) btn.style.display = "block";

    btn.addEventListener("click", () => {
      const ok = confirm("üß™ Reset LOCAL: borrar√° datos guardados en este tel√©fono (localStorage). ¬øContinuar?");
      if (!ok) return;

      // Borra TODO el localStorage de este dominio (GitHub Pages)
      localStorage.clear();

      alert("‚úÖ Listo. Se limpi√≥ el localStorage. Recarga la p√°gina para probar como cliente nuevo.");
      location.reload();
    });
  })();
</script>
</body>
</html>
